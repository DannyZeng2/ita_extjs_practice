<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" type="text/css" href="../../resources/css/ext-all.css" />
    <script type="text/javascript" src="../../adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="../../ext-all-debug.js"></script>
    <script type="text/javascript">

        Ext.onReady(function () {

            var root = new Ext.tree.TreeNode({
                text: '计算机学院', checked: false
            });
            var cs = new Ext.tree.TreeNode({
                text: '计算机科学与技术', checked: false
            });
            var se = new Ext.tree.TreeNode({
                text: '软件工程', checked: false
            });

            var danny = new Ext.tree.TreeNode({ text: 'Danny', checked: false,leaf:true });
            var alan = new Ext.tree.TreeNode({ text: 'Alan', checked: false ,leaf:true});
            var sally = new Ext.tree.TreeNode({ text: 'Sally', checked: false ,leaf:true});
            var ban = new Ext.tree.TreeNode({ text: 'Ben', checked: false ,leaf:true});
            var mike = new Ext.tree.TreeNode({ text: 'Mike', checked: false ,leaf:true});
            var jack = new Ext.tree.TreeNode({ text: 'Jack', checked: false ,leaf:true});

            root.appendChild(cs);
            root.appendChild(se);

            cs.appendChild(danny);
            cs.appendChild(alan);
            cs.appendChild(jack);
            se.appendChild(sally);
            se.appendChild(ban);
            se.appendChild(mike);



            var tbar = new Ext.Toolbar({
                renderTo: 'tbar',
                width: 200,
                items: [{ xtype: 'textfield', emptyText: 'filter', id: 'filter_input', width: 150 },
                {
                    id: 'filter',
                    xtype: 'button',
                    width: 50,
                    unstyle: true,
                    text: '过滤',
                    style: 'margin:0px 150px 0px 0px;',
                }],

            });
            tbar.render();

            var bbar = new Ext.Toolbar({
                renderTo: 'bbar',
                width: 200,
                items: [{ xtype: 'textfield', emptyText: 'add', id: 'add_input', width: 130 },
                {
                    id: 'add',
                    xtype: 'button',
                    width: 70,
                    unstyle: true,
                    text: '添加学生',
                    style: 'margin:0px 150px 0px 0px;',
                }],

            });
            bbar.render();

            var menu = new Ext.menu.Menu({
                items: [{
                    id: 'showInfo',
                    text: 'Show Information'
                },
                {
                    id: 'addInfo',
                    text: 'Add'
                }],
                listeners: {
                    itemclick: function (item) {
                        switch (item.id) {
                            case 'showInfo':
                                var node = item.parentMenu.contextNode;
                                if (node.parentNode) {
                                    Ext.Msg.alert('学生信息', node.parentNode.text + '的' + node.text);
                                } else if (node) {
                                    Ext.Msg.alert('学生信息', node.text);
                                }
                                break;
                            case 'addInfo':
                                var node = item.parentMenu.contextNode;
                                if (node.parentNode) {
                                    console.log(node.parentNode.attributes.children)
                                }
                                break;
                        }
                    }
                }
            });
            var selectedNode = '';

            var tree = new Ext.tree.TreePanel({
                renderTo: 'tree',
                width: 200,
                height: 300,
                animate: true,
                enableDD: true,
                root: root,
                //loader: new Ext.tree.TreeLoader({ dataUrl: './data/tree.txt' }),
                selModel: new Ext.tree.MultiSelectionModel({}),
                contextMenu: menu,
                listeners: {
                    contextmenu: function (node, e) {
                        node.select();
                        var treeContextMenu = node.getOwnerTree().contextMenu;
                        treeContextMenu.contextNode = node;
                        treeContextMenu.showAt(e.getXY());
                    },
                    nodedrop: function (e) {
                        Ext.Msg.alert('Drag Event', e.dropNode.text + '被移动到' + e.target.parentNode.text);

                    },
                    'click': function (node) {
                        selectedNode = node;
                    }
                }

            });

            var treeEditor = new Ext.tree.TreeEditor(tree, { allowBlank: false }, {
                listeners: {
                    complete: function (editor, currVal, origVal) {

                        Ext.Msg.alert('修改成功', origVal + '已修改为' + currVal);

                    },

                }
            });

            var filter = new Ext.tree.TreeFilter(tree, {
                clearBlank: true,
                autoClear: true
            });


            var hiddenPkgs = [];

            Ext.getCmp('filter').on('click', function (e) {
                var text = Ext.getCmp('filter_input').getValue();

                Ext.each(hiddenPkgs, function (node) {
                    node.ui.show();
                    console.log(node.ui)
                });

                if (!text) {
                    filter.clear();
                    return;
                }
                tree.expandAll();

                var reg = new RegExp(Ext.escapeRe(text), 'i');
                filter.filterBy(function (node) {
                    return !node.isLeaf() || reg.test(node.text);
                });

                hiddenPkgs = [];
                tree.root.cascade(function (node) {
                    if (!node.isLeaf() && node.ui.ctNode.offsetHeight < 3) {
                        node.ui.hide();
                        hiddenPkgs.push(node);
                    }
                });

                tree.render();

            });

            Ext.getCmp('add').on('click', function (e) {
                var value = Ext.getCmp('add_input').getValue();
                var obj = {};
                obj.text = value;
                obj.leaf = true;
                obj.checked = false;
                var student = new Ext.tree.TreeNode(obj);
                console.log(selectedNode);
                if (selectedNode.attributes.text === "计算机学院") {
                    obj.text = value;
                    obj.leaf = false;
                    obj.checked = false;
                    var className = new Ext.tree.TreeNode(obj);
                    root.appendChild(className);
                } else if(selectedNode.attributes.leaf === true) {
                    selectedNode.parentNode.appendChild(student);
                }else{
                    selectedNode.appendChild(student);
                }


            });

        });

    </script>

</head>

<body>
    <div id='tbar'></div>
    <div id='tree'></div>
    <div id='bbar'></div>
</body>

</html>